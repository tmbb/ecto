<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.17.1">
    <title>Ecto Association Guide – Ecto v3.0.0-dev</title>
    <link rel="stylesheet" href="dist/app-110d9134a6.css" />
    
      <link rel="canonical" href="http://hexdocs.pm/ecto/associations.html" />
    
    
      
        <link rel="icon" type="image/png" href="assets/logo.png" />
      
      
    
    <script src="dist/sidebar_items-d4f8a3d044.js"></script>
    <link rel="stylesheet" href="assets/makedown.css"/>
  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode')) document.body.className += ' night-mode'; } catch (e) { }</script>

<div class="main">
<button class="sidebar-toggle">
  <span class="icon-menu" aria-hidden="true"></span>
  <span class="sr-only">Toggle Sidebar</span>
</button>
<section class="sidebar">

  
  <a href="Ecto.html" class="sidebar-projectLink">
    <div class="sidebar-projectDetails">
      <h1 class="sidebar-projectName">
        Ecto
      </h1>
      <h2 class="sidebar-projectVersion">
        v3.0.0-dev
      </h2>
    </div>
    
      <img src="assets/logo.png" alt="Ecto" class="sidebar-projectImage">
    
  </a>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <input name="q" type="text" id="search-list" class="search-input" placeholder="search" aria-label="Search" autocomplete="off" />
  </form>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

    
      <li><a id="modules-list" href="#full-list">Modules</a></li>
    

    
      <li><a id="exceptions-list" href="#full-list">Exceptions</a></li>
    

    
      <li><a id="tasks-list" href="#full-list">Mix Tasks</a></li>
    
  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">


<h1>Ecto Association Guide</h1>
<p>This guide assumes you worked through the <a href="Getting%2520Started.md">Getting Started guide</a> and want to learn more about associations.</p>
<p>There are three kinds of associations:</p>
<ul>
<li>one-to-one
</li>
<li>one-to-many
</li>
<li>many-to-many
</li>
</ul>
<p>In this tutorial we’re going to create a minimal Ecto project then we’re going to create basic schemas and migrations, and finally associate the schemas.</p>
<h2 id="ecto-setup" class="section-heading">
  <a href="#ecto-setup" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Ecto Setup
</h2>

<p>First, we’re going to create a fresh Ecto project which is going to be used for the rest of the tutorial:</p>
<pre><code class="">$ mix new ecto_assoc --sup</code></pre>
<p>Add <code class="inline">ecto</code> and <code class="inline">postgrex</code> as dependencies to <code class="inline">mix.exs</code></p>
<pre><code class="nohighlight makeup"><span class="c1"># mix.exs
</span><span class="kd">defp</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="k" data-group-id="34">do</span><span class="w">
  </span><span class="p" data-group-id="29">[</span><span class="p" data-group-id="6">{</span><span class="ss">:ecto</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p" data-group-id="6">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="28">{</span><span class="ss">:postgrex</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;~&gt; 0.11&quot;</span><span class="p" data-group-id="28">}</span><span class="p" data-group-id="29">]</span><span class="w">
</span><span class="k" data-group-id="34">end</span></code></pre>
<p>Let’s generate a repo and create the corresponding DB.</p>
<pre><code class="">$ mix ecto.gen.repo -r EctoAssoc.Repo</code></pre>
<p>Make sure the config for the repo is set properly:</p>
<pre><code class="nohighlight makeup"><span class="c1"># config/config.exs
</span><span class="n">config</span><span class="w"> </span><span class="ss">:ecto_assoc</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Repo</span><span class="p">,</span><span class="w">
  </span><span class="ss">adapter</span><span class="p">:</span><span class="w"> </span><span class="nc">Ecto.Adapters.Postgres</span><span class="p">,</span><span class="w">
  </span><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ecto_assoc_repo&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;localhost&quot;</span><span class="w">

</span><span class="n">config</span><span class="w"> </span><span class="ss">:ecto_assoc</span><span class="p">,</span><span class="w"> </span><span class="ss">ecto_repos</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="101">[</span><span class="nc">EctoAssoc.Repo</span><span class="p" data-group-id="101">]</span></code></pre>
<p>Add the repo to the supervision tree:</p>
<pre><code class="nohighlight makeup"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="1">(</span><span class="n">_type</span><span class="p">,</span><span class="w"> </span><span class="n">_args</span><span class="p" data-group-id="1">)</span><span class="w"> </span><span class="k">do</span><span class="w">
    </span><span class="kn">import</span><span class="w"> </span><span class="nc">Supervisor.Spec</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="105">[</span><span class="w">
      </span><span class="n">supervisor</span><span class="p" data-group-id="104">(</span><span class="nc">EctoAssoc.Repo</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="103">[]</span><span class="p" data-group-id="104">)</span><span class="w">
    </span><span class="p" data-group-id="105">]</span><span class="w">
    </span><span class="o">...</span></code></pre>
<p>Finally let’s create the DB:</p>
<pre><code class="">$ mix ecto.create</code></pre>
<h2 id="one-to-one" class="section-heading">
  <a href="#one-to-one" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  One-to-one
</h2>

<h3 id="prep" class="section-heading">
  <a href="#prep" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Prep
</h3>

<p>Let’s start with two schemas that are not yet associated: <code class="inline">User</code> and <code class="inline">Avatar</code>.</p>
<p>We will generate the migration for <code class="inline">User</code>:</p>
<pre><code class="nohighlight makeup"><span class="n">mix</span><span class="w"> </span><span class="n">ecto</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">migration</span><span class="w"> </span><span class="n">create_user</span></code></pre>
<p>And add some columns:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*_create_user.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.CreateUser</span><span class="w"> </span><span class="k" data-group-id="70">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="60">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="13">(</span><span class="ss">:users</span><span class="p" data-group-id="13">)</span><span class="w"> </span><span class="k" data-group-id="49">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="k" data-group-id="49">end</span><span class="w">
  </span><span class="k" data-group-id="60">end</span><span class="w">
</span><span class="k" data-group-id="70">end</span></code></pre>
<p>And the following schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/user.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.User</span><span class="w"> </span><span class="k" data-group-id="39">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="w"> </span><span class="k" data-group-id="30">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
  </span><span class="k" data-group-id="30">end</span><span class="w">
</span><span class="k" data-group-id="39">end</span></code></pre>
<p>Avatar also has its own migration as well:</p>
<pre><code class="">mix ecto.gen.migration create_avatar</code></pre>
<p>with the following columns:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*_create_avatar.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.CreateAvatar</span><span class="w"> </span><span class="k" data-group-id="68">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="56">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="10">(</span><span class="ss">:avatars</span><span class="p" data-group-id="10">)</span><span class="w"> </span><span class="k" data-group-id="47">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:nick_name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:pic_url</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="k" data-group-id="47">end</span><span class="w">
  </span><span class="k" data-group-id="56">end</span><span class="w">
</span><span class="k" data-group-id="68">end</span></code></pre>
<p>and the following schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/avatar.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Avatar</span><span class="w"> </span><span class="k" data-group-id="35">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;avatars&quot;</span><span class="w"> </span><span class="k" data-group-id="27">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:nick_name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:pic_url</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
  </span><span class="k" data-group-id="27">end</span><span class="w">
</span><span class="k" data-group-id="35">end</span></code></pre>
<h3 id="adding-associations" class="section-heading">
  <a href="#adding-associations" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding Associations
</h3>

<p>Now we want to associate the user with the avatar and vice-versa:</p>
<ul>
<li>one user has one avatar
</li>
<li>one avatar belongs to one user
</li>
</ul>
<p>The difference between <a href="Ecto.Schema.html#has_one/3"><code class="inline">has_one</code></a> and <a href="Ecto.Schema.html#belongs_to/3"><code class="inline">belongs_to</code></a> is where the primary key belongs. In this case, we want the “avatars” table to have a “user_id” columns, therefore the avatar belongs to the user.</p>
<p>For the <em>avatar</em> we create a migration that adds a <code class="inline">user_id</code> reference:</p>
<pre><code class="">mix ecto.gen.migration avatar_belongs_to_user</code></pre>
<p>with the following steps:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/20161117101812_avatar_belongs_to_user.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.AvatarBelongsToUser</span><span class="w"> </span><span class="k" data-group-id="76">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="67">do</span><span class="w">
    </span><span class="n">alter</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="23">(</span><span class="ss">:avatars</span><span class="p" data-group-id="23">)</span><span class="w"> </span><span class="k" data-group-id="55">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="42">(</span><span class="ss">:users</span><span class="p" data-group-id="42">)</span><span class="w">
    </span><span class="k" data-group-id="55">end</span><span class="w">
  </span><span class="k" data-group-id="67">end</span><span class="w">
</span><span class="k" data-group-id="76">end</span></code></pre>
<p>This adds a <code class="inline">user_id</code> column to the DB which references an entry in the users table.</p>
<p>For the <em>avatar</em> we add a <code class="inline">belongs_to</code> field to the schema:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Avatar</span><span class="w"> </span><span class="k" data-group-id="57">do</span><span class="w">
  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;avatars&quot;</span><span class="w"> </span><span class="k" data-group-id="46">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:nick_name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:pic_url</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.User</span><span class="w">  </span><span class="c1"># this was added
</span><span class="w">  </span><span class="k" data-group-id="46">end</span><span class="w">
</span><span class="k" data-group-id="57">end</span></code></pre>
<p><code class="inline">belongs_to</code> is a macro which uses a foreign key (in this case <code class="inline">user_id</code>) to make the associated schema accessible through the avatar. In this case, you can access the user via <code class="inline">avatar.user</code>.</p>
<p>For the <em>user</em> we add a <code class="inline">has_one</code> field to the schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/user.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.User</span><span class="w"> </span><span class="k" data-group-id="63">do</span><span class="w">
  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="w"> </span><span class="k" data-group-id="52">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">has_one</span><span class="w"> </span><span class="ss">:avatar</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Avatar</span><span class="w">  </span><span class="c1"># this was added
</span><span class="w">  </span><span class="k" data-group-id="52">end</span><span class="w">
</span><span class="k" data-group-id="63">end</span></code></pre>
<p><code class="inline">has_one</code> does not add anything to the DB. The foreign key of the associated schema, <code class="inline">Avatar</code>, is used to make the avatar available from the user, allowing you to access the avatar via <code class="inline">user.avatar</code>.</p>
<h3 id="persistence" class="section-heading">
  <a href="#persistence" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Persistence
</h3>

<p>Now let’s add data to the DB. Start iex:</p>
<pre><code class="">$ iex -S mix</code></pre>
<p>For convenience we alias some modules:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">EctoAssoc</span><span class="o">.</span><span class="p" data-group-id="12">{</span><span class="nc">Repo</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="nc">Avatar</span><span class="p" data-group-id="12">}</span></code></pre>
<p>Create a user struct and insert it into the repo:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9">%</span><span class="nc" data-group-id="9">User</span><span class="p" data-group-id="9">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john.doe@example.com&quot;</span><span class="p" data-group-id="9">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="53">(</span><span class="n">user</span><span class="p" data-group-id="53">)</span><span class="w">
</span><span class="p" data-group-id="106">%</span><span class="nc" data-group-id="106">EctoAssoc.User</span><span class="p" data-group-id="106">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;,
</span><span class="w"> </span><span class="ss">avatar</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :avatar is not loaded&gt;,
</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john.doe@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p" data-group-id="106">}</span></code></pre>
<p>This time let’s add another user with an avatar association. We can define it directly in the User struct in the <code class="inline">:avatar</code> field:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="20">%</span><span class="nc" data-group-id="20">Avatar</span><span class="p" data-group-id="20">{</span><span class="ss">nick_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Elixir&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">pic_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://elixir-lang.org/images/logo.png&quot;</span><span class="p" data-group-id="20">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="86">%</span><span class="nc" data-group-id="86">User</span><span class="p" data-group-id="86">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Jane Doe&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jane@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">avatar</span><span class="p">:</span><span class="w"> </span><span class="n">avatar</span><span class="p" data-group-id="86">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="102">(</span><span class="n">user</span><span class="p" data-group-id="102">)</span><span class="w">
</span><span class="p" data-group-id="190">%</span><span class="nc" data-group-id="190">EctoAssoc.User</span><span class="p" data-group-id="190">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;,
</span><span class="w"> </span><span class="ss">avatar</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="134">%{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;avatars&quot;&gt;,
</span><span class="w">   </span><span class="ss">__struct__</span><span class="p">:</span><span class="w"> </span><span class="nc">EctoAssoc.Avatar</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">nick_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Elixir&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">pic_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://elixir-lang.org/images/logo.png&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;,
</span><span class="w">   </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="134">}</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jane@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Jane Doe&quot;</span><span class="p" data-group-id="190">}</span></code></pre>
<p>Let’s verify that it works by retrieving all Users and their associated avatars:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p" data-group-id="2">(</span><span class="nc">User</span><span class="p" data-group-id="2">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="21">(</span><span class="ss">:avatar</span><span class="p" data-group-id="21">)</span><span class="w">
</span><span class="p" data-group-id="167">[</span><span class="p" data-group-id="96">%</span><span class="nc" data-group-id="96">EctoAssoc.User</span><span class="p" data-group-id="96">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;, avatar: nil,
</span><span class="w">  </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john.doe@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p" data-group-id="96">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="166">%</span><span class="nc" data-group-id="166">EctoAssoc.User</span><span class="p" data-group-id="166">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;,
</span><span class="w">  </span><span class="ss">avatar</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="119">%</span><span class="nc" data-group-id="119">EctoAssoc.Avatar</span><span class="p" data-group-id="119">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;avatars&quot;&gt;,
</span><span class="w">   </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">nick_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Elixir&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">pic_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://elixir-lang.org/images/logo.png&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;,
</span><span class="w">   </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="119">}</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jane@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Jane Doe&quot;</span><span class="p" data-group-id="166">}</span><span class="p" data-group-id="167">]</span></code></pre>
<h2 id="one-to-many" class="section-heading">
  <a href="#one-to-many" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  One-to-many
</h2>

<h3 id="prep" class="section-heading">
  <a href="#prep" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Prep
</h3>

<p>Let’s assume we have two schemas: <code class="inline">User</code> and <code class="inline">Post</code>. The <code class="inline">User</code> was defined in the previous section and the <code class="inline">Post</code> one will be defined now.</p>
<p>Let’s start with the migration:</p>
<pre><code class="">mix ecto.gen.migration create_post</code></pre>
<p>with the following columns:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*_create_post.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.CreatePost</span><span class="w"> </span><span class="k" data-group-id="75">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="64">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="17">(</span><span class="ss">:posts</span><span class="p" data-group-id="17">)</span><span class="w"> </span><span class="k" data-group-id="50">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:header</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="k" data-group-id="50">end</span><span class="w">
  </span><span class="k" data-group-id="64">end</span><span class="w">
</span><span class="k" data-group-id="75">end</span></code></pre>
<p>and the following schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/post.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="w"> </span><span class="k" data-group-id="37">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;posts&quot;</span><span class="w"> </span><span class="k" data-group-id="31">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:header</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
  </span><span class="k" data-group-id="31">end</span><span class="w">
</span><span class="k" data-group-id="37">end</span></code></pre>
<h3 id="adding-associations" class="section-heading">
  <a href="#adding-associations" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding Associations
</h3>

<p>Now we want to associate the user with the post and vice-versa:</p>
<ul>
<li>one user has many posts
</li>
<li>one post belongs to one user
</li>
</ul>
<p>As in <code class="inline">one-to-one</code> associations, the belongs_to reveals on which table the foreign key should be added. For the <em>post</em> we create a migration that adds a <code class="inline">user_id</code> reference:</p>
<pre><code class="">mix ecto.gen.migration post_belongs_to_user</code></pre>
<p>with the following contents:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*_post_belongs_to_user.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.PostBelongsToUser</span><span class="w"> </span><span class="k" data-group-id="74">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="65">do</span><span class="w">
    </span><span class="n">alter</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="22">(</span><span class="ss">:posts</span><span class="p" data-group-id="22">)</span><span class="w"> </span><span class="k" data-group-id="51">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:user_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="41">(</span><span class="ss">:users</span><span class="p" data-group-id="41">)</span><span class="w">
    </span><span class="k" data-group-id="51">end</span><span class="w">
  </span><span class="k" data-group-id="65">end</span><span class="w">
</span><span class="k" data-group-id="74">end</span></code></pre>
<p>For the <em>post</em> we add a <code class="inline">belongs_to</code> field to the schema:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="w"> </span><span class="k" data-group-id="66">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;posts&quot;</span><span class="w"> </span><span class="k" data-group-id="54">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:header</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.User</span><span class="w">  </span><span class="c1"># this was added
</span><span class="w">  </span><span class="k" data-group-id="54">end</span><span class="w">
</span><span class="k" data-group-id="66">end</span></code></pre>
<p><code class="inline">belongs_to</code> is a macro which uses a foreign key (in this case <code class="inline">user_id</code>) to make the associated schema accessible through the post. The user can be accessed via <code class="inline">post.user</code>.</p>
<p>For the <em>user</em> we add a <code class="inline">has_many</code> field to the schema:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.User</span><span class="w"> </span><span class="k" data-group-id="59">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="w"> </span><span class="k" data-group-id="48">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">has_many</span><span class="w"> </span><span class="ss">:posts</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="w">  </span><span class="c1"># this was added
</span><span class="w">  </span><span class="k" data-group-id="48">end</span><span class="w">
</span><span class="k" data-group-id="59">end</span></code></pre>
<p><a href="Ecto.Schema.html#has_many/3"><code class="inline">has_many</code></a> does not require anything to the DB. The foreign key of the associated schema, <code class="inline">Post</code>, is used to make the posts available from the user, allowing all posts for a given to user to be accessed via <code class="inline">user.posts</code>.</p>
<h3 id="persistence" class="section-heading">
  <a href="#persistence" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Persistence
</h3>

<p>Start iex:</p>
<pre><code class="">$ iex -S mix</code></pre>
<p>For convenience we alias some modules:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">EctoAssoc</span><span class="o">.</span><span class="p" data-group-id="18">{</span><span class="nc">Repo</span><span class="p">,</span><span class="w"> </span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="nc">Post</span><span class="p" data-group-id="18">}</span></code></pre>
<p>Let’s create a User and store it in the DB:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="19">%</span><span class="nc" data-group-id="19">User</span><span class="p" data-group-id="19">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john.doe@example.com&quot;</span><span class="p" data-group-id="19">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="58">(</span><span class="n">user</span><span class="p" data-group-id="58">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.User</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;,
</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john.doe@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}</span></code></pre>
<p>Let’s build an associated post and store it in the DB. We can take a similar approach as we did in <code class="inline">one_to_one</code> and directly pass a list of posts in the <code class="inline">posts</code> field when inserting the user, effectively inserting the user and multiple posts at once.</p>
<p>However, let’s try a different approach and use <a href="Ecto.html#build_assoc/3"><code class="inline">Ecto.build_assoc/3</code></a> to build a post that is associated to the existing user we have just defined:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto</span><span class="o">.</span><span class="n">build_assoc</span><span class="p" data-group-id="62">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="ss">:posts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="61">%{</span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p" data-group-id="61">}</span><span class="p" data-group-id="62">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:built, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;, user_id: 1}
</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="258">(</span><span class="n">post</span><span class="p" data-group-id="258">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;, user_id: 1}</span></code></pre>
<p>Let’s add another post to the user:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto</span><span class="o">.</span><span class="n">build_assoc</span><span class="p" data-group-id="80">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="ss">:posts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="79">%{</span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5 ways to improve your Ecto&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Add url of this tutorial&quot;</span><span class="p" data-group-id="79">}</span><span class="p" data-group-id="80">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="90">(</span><span class="n">post</span><span class="p" data-group-id="90">)</span><span class="w">
</span><span class="p" data-group-id="108">%</span><span class="nc" data-group-id="108">EctoAssoc.Post</span><span class="p" data-group-id="108">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Add url of this tutorial&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5 ways to improve your Ecto&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;,
</span><span class="w"> </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="108">}</span></code></pre>
<p>Let’s see if it worked:</p>
<pre><code class="">iex&gt; Repo.get(User, user.id) |&gt; Repo.preload(:posts)
%EctoAssoc.User{__meta__: #Ecto.Schema.Metadata&lt;:loaded, &quot;users&quot;&gt;,
 email: &quot;john.doe@example.com&quot;, id: 1, name: &quot;John Doe&quot;,
 posts: [%EctoAssoc.Post{__meta__: #Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
   body: &quot;No real content&quot;, header: &quot;Clickbait header&quot;, id: 1,
   user: #Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;,
   user_id: 1},
  %EctoAssoc.Post{__meta__: #Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
   body: &quot;Add url of this tutorial&quot;, header: &quot;5 ways to improve your Ecto&quot;,
   id: 2, user: #Ecto.Association.NotLoaded&lt;association :user is not loaded&gt;,
   user_id: 1}]}</code></pre>
<p>In the example above, <code class="inline">Ecto.build_assoc</code> received an existing <code class="inline">user</code> struct, that was already persisted to the database, and built a <code class="inline">Post</code> struct, based on its <code class="inline">:posts</code> association, with the <code class="inline">user_id</code> foreign key field properly set to the ID in the <code class="inline">user</code> struct.</p>
<h2 id="many-to-many" class="section-heading">
  <a href="#many-to-many" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Many-to-many
</h2>

<h3 id="prep" class="section-heading">
  <a href="#prep" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Prep
</h3>

<p>Let’s assume we have two schemas: <code class="inline">Post</code> and <code class="inline">Tag</code>. The <code class="inline">Post</code> was defined in the previous section and the <code class="inline">Tag</code> one will be defined now.</p>
<p>Let’s start with the tag migration:</p>
<pre><code class="">mix ecto.gen.migration create_tag</code></pre>
<p>with the following columns:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*create_tag.exs
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.CreateTag</span><span class="w"> </span><span class="k" data-group-id="40">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="32">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="8">(</span><span class="ss">:tags</span><span class="p" data-group-id="8">)</span><span class="w"> </span><span class="k" data-group-id="26">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="k" data-group-id="26">end</span><span class="w">
  </span><span class="k" data-group-id="32">end</span><span class="w">
</span><span class="k" data-group-id="40">end</span></code></pre>
<p>and the following schema:</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Tag</span><span class="w"> </span><span class="k" data-group-id="25">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;tags&quot;</span><span class="w"> </span><span class="k" data-group-id="16">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
  </span><span class="k" data-group-id="16">end</span><span class="w">
</span><span class="k" data-group-id="25">end</span></code></pre>
<h3 id="adding-associations" class="section-heading">
  <a href="#adding-associations" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Adding Associations
</h3>

<p>Now we want to associate the post with the tags and vice-versa:</p>
<ul>
<li>one post can have many tags
</li>
<li>one tag can have many posts
</li>
</ul>
<p>This is a <code class="inline">many-to-many</code> relationship. Notice both sides can have many entries. In the previous sections we were used to put the foreign key on the side that “belongs to” the other, which is not available here.</p>
<p>One way to handle <code class="inline">many-to-many</code> relationships is to introduce an additional table which explicitly tracks the tag-post relationship by pointing to both tags and posts entries.</p>
<p>So let’s do that:</p>
<pre><code class="">mix ecto.gen.migration create_posts_tags</code></pre>
<p>with the following contents:</p>
<pre><code class="nohighlight makeup"><span class="c1"># priv/repo/migrations/*_create_posts_tags
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Repo.Migrations.CreatePostsTags</span><span class="w"> </span><span class="k" data-group-id="99">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="k" data-group-id="98">do</span><span class="w">
    </span><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="15">(</span><span class="ss">:posts_tags</span><span class="p" data-group-id="15">)</span><span class="w"> </span><span class="k" data-group-id="84">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:tag_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="36">(</span><span class="ss">:tags</span><span class="p" data-group-id="36">)</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:post_id</span><span class="p">,</span><span class="w"> </span><span class="n">references</span><span class="p" data-group-id="73">(</span><span class="ss">:posts</span><span class="p" data-group-id="73">)</span><span class="w">
    </span><span class="k" data-group-id="84">end</span><span class="w">

    </span><span class="n">create</span><span class="w"> </span><span class="n">unique_index</span><span class="p" data-group-id="95">(</span><span class="ss">:posts_tags</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="94">[</span><span class="ss">:tag_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:post_id</span><span class="p" data-group-id="94">]</span><span class="p" data-group-id="95">)</span><span class="w">
  </span><span class="k" data-group-id="98">end</span><span class="w">
</span><span class="k" data-group-id="99">end</span></code></pre>
<p>On the DB level, this creates a new table <code class="inline">posts_tags</code> with two columns that point at the <code class="inline">tag_id</code> and <code class="inline">post_id</code>. We also create a unique index, such that the association is always unique.</p>
<p>For the <em>post</em> we use the <a href="Ecto.Schema.html#many_to_many/3"><code class="inline">many_to_many</code></a> macro to associate the <code class="inline">Tag</code> through the
new <code class="inline">posts_tags</code> table.</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/post.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="w"> </span><span class="k" data-group-id="88">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;posts&quot;</span><span class="w"> </span><span class="k" data-group-id="87">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:header</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="c1"># the following line was added
</span><span class="w">    </span><span class="n">many_to_many</span><span class="w"> </span><span class="ss">:tags</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Tag</span><span class="p">,</span><span class="w"> </span><span class="ss">join_through</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;posts_tags&quot;</span><span class="w">
  </span><span class="k" data-group-id="87">end</span><span class="w">
</span><span class="k" data-group-id="88">end</span></code></pre>
<p>For the <em>tag</em> we do the same. We use the <code class="inline">many_to_many</code> macro to associate the <code class="inline">Post</code> through the
new <code class="inline">posts_tags</code> schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/tag.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Tag</span><span class="w"> </span><span class="k" data-group-id="85">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;tags&quot;</span><span class="w"> </span><span class="k" data-group-id="83">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="c1"># the following line was added
</span><span class="w">    </span><span class="n">many_to_many</span><span class="w"> </span><span class="ss">:posts</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="p">,</span><span class="w"> </span><span class="ss">join_through</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;posts_tags&quot;</span><span class="w">
  </span><span class="k" data-group-id="83">end</span><span class="w">
</span><span class="k" data-group-id="85">end</span></code></pre>
<h3 id="persistence" class="section-heading">
  <a href="#persistence" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Persistence
</h3>

<p>Let’s create some tags:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">clickbait_tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="w"> </span><span class="p" data-group-id="7">%</span><span class="nc" data-group-id="7">Tag</span><span class="p" data-group-id="7">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p" data-group-id="7">}</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1,
</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}
</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">misc_tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="w"> </span><span class="p" data-group-id="276">%</span><span class="nc" data-group-id="276">Tag</span><span class="p" data-group-id="276">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p" data-group-id="276">}</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 2,
</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}
</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">ecto_tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="w"> </span><span class="p" data-group-id="287">%</span><span class="nc" data-group-id="287">Tag</span><span class="p" data-group-id="287">{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ecto&quot;</span><span class="p" data-group-id="287">}</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 3,
</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ecto&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}</span></code></pre>
<p>And let’s create a post:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="24">%</span><span class="nc" data-group-id="24">Post</span><span class="p" data-group-id="24">{</span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p" data-group-id="24">}</span><span class="w">
</span><span class="gp">...&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="69">(</span><span class="n">post</span><span class="p" data-group-id="69">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">tags</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :tags is not loaded&gt;}</span></code></pre>
<p>Ok, but tag and post are not associated, yet. We for, as done in <code class="inline">one-to-one</code>, create either a post or a tag with the associated entries and insert them all at once. However, notice we cannot use <a href="Ecto.html#build_assoc/3"><code class="inline">Ecto.build_assoc/3</code></a>, since the foreign key does not belong to the <code class="inline">post</code> nor the <code class="inline">tag</code> struct.</p>
<p>Another option is to use Ecto changesets, which provides many conveniences for dealing with <em>changes</em>. For example:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="4">(</span><span class="n">post</span><span class="p" data-group-id="4">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_with_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="82">(</span><span class="n">post_changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">:tags</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="81">[</span><span class="n">clickbait_tag</span><span class="p">,</span><span class="w"> </span><span class="n">misc_tag</span><span class="p" data-group-id="81">]</span><span class="p" data-group-id="82">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update!</span><span class="p" data-group-id="93">(</span><span class="n">post_with_tags</span><span class="p" data-group-id="93">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">tags</span><span class="p">:</span><span class="w"> </span><span class="p">[%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1,
</span><span class="w">   </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;},
</span><span class="w">  </span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 2,
</span><span class="w">   </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}]}</span></code></pre>
<p>Let’s examine the post:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="14">(</span><span class="nc">Post</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="38">(</span><span class="ss">:tags</span><span class="p" data-group-id="38">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">tags</span><span class="p">:</span><span class="w"> </span><span class="p">[%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1,
</span><span class="w">   </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;},
</span><span class="w">  </span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 2,
</span><span class="w">   </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}]}
</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="o">.</span><span class="n">header</span><span class="w">
</span><span class="s2">&quot;Clickbait header&quot;</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="o">.</span><span class="n">body</span><span class="w">
</span><span class="s2">&quot;No real content&quot;</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="o">.</span><span class="n">tags</span><span class="w">
</span><span class="p">[%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1,
</span><span class="w">  </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;},
</span><span class="w"> </span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 2,
</span><span class="w">  </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;}]
</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2204">(</span><span class="n">post</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">name</span><span class="p" data-group-id="2204">)</span><span class="w">
</span><span class="p" data-group-id="2205">[</span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;misc&quot;</span><span class="p" data-group-id="2205">]</span></code></pre>
<p>The associations also works in the other direction:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="11">(</span><span class="nc">Tag</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="11">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">preload</span><span class="p" data-group-id="33">(</span><span class="ss">:posts</span><span class="p" data-group-id="33">)</span><span class="w">
</span><span class="p">%</span><span class="nc">EctoAssoc.Tag</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1,
</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clickbait&quot;</span><span class="p">,</span><span class="w">
 </span><span class="ss">posts</span><span class="p">:</span><span class="w"> </span><span class="p">[%</span><span class="nc">EctoAssoc.Post</span><span class="err">{</span><span class="ss">__meta__</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &quot;posts&quot;&gt;,
</span><span class="w">   </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No real content&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">header</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clickbait header&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">tags</span><span class="p">:</span><span class="w"> </span><span class="c1">#Ecto.Association.NotLoaded&lt;association :tags is not loaded&gt;}]}</span></code></pre>
<p>The advantage of using Ecto.Changeset is that it is responsible for tracking the changes between your data structures and the associated data. For example, if you want you remove the clickbait tag from from the post, one way to do so is by calling <a href="Ecto.Changeset.html#put_assoc/4"><code class="inline">Ecto.Changeset.put_assoc/3</code></a> once more but without the clickbait tag.  This will not work right now, because the <code class="inline">:on_replace</code> option for the <code class="inline">many_to_many</code> relationship defaults to <code class="inline">:raise</code>.  Go ahead and try it.  When you try to call <code class="inline">put_assoc</code>, a runtime error will be raised:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="3">(</span><span class="n">post</span><span class="p" data-group-id="3">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_with_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="72">(</span><span class="n">post_changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">:tags</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="71">[</span><span class="n">misc_tag</span><span class="p" data-group-id="71">]</span><span class="p" data-group-id="72">)</span><span class="w">
</span><span class="o">**</span><span class="w"> </span><span class="p" data-group-id="89">(</span><span class="nc">RuntimeError</span><span class="p" data-group-id="89">)</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">relation</span><span class="w"> </span><span class="ss">:tags</span><span class="w"> </span><span class="n">of</span><span class="w">
</span><span class="nc">Website.CMS.Page</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="ss">:on_replace</span><span class="err">`</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">of</span><span class="w">
</span><span class="n">this</span><span class="w"> </span><span class="n">relation</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="ss">:raise</span><span class="err">`</span><span class="o">.</span><span class="w">

</span><span class="nc">By</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">delete</span><span class="w"> </span><span class="n">embeds</span><span class="w"> </span><span class="ow">and</span><span class="w">
</span><span class="n">associations</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="err">`</span><span class="n">cast</span><span class="err">`</span><span class="o">.</span><span class="w"> </span><span class="nc">Therefore</span><span class="w"> </span><span class="nc">Ecto</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">existing</span><span class="w">
</span><span class="n">data</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">update</span><span class="o">.</span><span class="w"> </span><span class="nc">Failing</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">this</span><span class="w">
</span><span class="n">error</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="w">

</span><span class="nc">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">automatically</span><span class="w"> </span><span class="n">delete</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">data</span><span class="w">
</span><span class="ow">not</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">cast</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">appropriate</span><span class="w"> </span><span class="err">`</span><span class="ss">:on_replace</span><span class="err">`</span><span class="w">
</span><span class="n">option</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">defining</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">relation</span><span class="o">.</span><span class="w"> </span><span class="nc">The</span><span class="w"> </span><span class="n">docs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="259">[</span><span class="err">`</span><span class="nc">Ecto.Changeset</span><span class="err">`</span><span class="p" data-group-id="259">]</span><span class="p" data-group-id="261">(</span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">html</span><span class="p" data-group-id="261">)</span><span class="w">
</span><span class="n">covers</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s2">&quot;Related data&quot;</span><span class="w"> </span><span class="n">section</span><span class="o">.</span><span class="w">

</span><span class="nc">However</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">don</span><span class="err">&apos;</span><span class="n">t</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">replaced</span><span class="w"> </span><span class="ow">or</span><span class="w">
</span><span class="n">deleted</span><span class="p">,</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">updated</span><span class="p">,</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="ss">that</span><span class="p">:</span><span class="w">

  </span><span class="o">*</span><span class="w"> </span><span class="nc">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w">
    </span><span class="n">are</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p" data-group-id="266">(</span><span class="nc">ID</span><span class="p" data-group-id="266">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="w">

  </span><span class="o">*</span><span class="w"> </span><span class="nc">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">relationship</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">least</span><span class="w">
    </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="nc">N</span><span class="w"> </span><span class="n">children</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">update</span><span class="o">.</span><span class="w">
</span><span class="o">...</span></code></pre>
<p>You should carefully read the documentation for <a href="Ecto.Schema.html#many_to_many/3"><code class="inline">Ecto.Schema.many_to_many/3</code></a>. It makes sense in this case that we want to delete relationships in the join table <code class="inline">posts_tags</code> when updating a post with new tags.  Here we want to drop the tag “clickbait” and just keep the tag “misc”, so we really do want the relationship in the joining table to be removed.  To do that, change the definition of the <code class="inline">many_to_many/3</code> in the Post schema:</p>
<pre><code class="nohighlight makeup"><span class="c1"># lib/ecto_assoc/post.ex
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EctoAssoc.Post</span><span class="w"> </span><span class="k" data-group-id="97">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s2">&quot;posts&quot;</span><span class="w"> </span><span class="k" data-group-id="91">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:header</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:body</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="c1"># the following line was edited to change the on_replace option from its default value of :raise
</span><span class="w">    </span><span class="n">many_to_many</span><span class="w"> </span><span class="ss">:tags</span><span class="p">,</span><span class="w"> </span><span class="nc">EctoAssoc.Tag</span><span class="p">,</span><span class="w"> </span><span class="ss">join_through</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;posts_tags&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">on_replace</span><span class="p">:</span><span class="w"> </span><span class="ss">:delete</span><span class="w">
  </span><span class="k" data-group-id="91">end</span><span class="w">
</span><span class="k" data-group-id="97">end</span></code></pre>
<p>On the other hand, it probably <em>doesn’t</em> make much sense to be able to remove relationships from the other end.  That is, with just a tag, it is hard to decide if a post should be related to the tag or not.  So it makes sense that we should still raise an error if we try to change posts that are related to tags from the tag side of things.</p>
<p>With the <code class="inline">:on_replace</code> option changed, Ecto will compare the data you gave with the tags currently in the post and conclude the association between the post and the clickbait tag must be removed, as follows:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="5">(</span><span class="n">post</span><span class="p" data-group-id="5">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post_with_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">put_assoc</span><span class="p" data-group-id="78">(</span><span class="n">post_changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">:tags</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="77">[</span><span class="n">misc_tag</span><span class="p" data-group-id="77">]</span><span class="p" data-group-id="78">)</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">update!</span><span class="p" data-group-id="92">(</span><span class="n">post_with_tags</span><span class="p" data-group-id="92">)</span></code></pre>
<h2 id="references" class="section-heading">
  <a href="#references" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  References
</h2>

<ul>
<li><a href="https://hexdocs.pm/ecto/Ecto.Schema.html#belongs_to/3">Ecto.Schema.belongs_to</a>
</li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Schema.html#has_one/3">Ecto.Schema.has_one</a>
</li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Schema.html#has_many/3">Ecto.Schema.has_many</a>
</li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Schema.html#many_to_many/3">Ecto.Schema.many_to_many</a>
</li>
<li><a href="https://hexdocs.pm/ecto/Ecto.html#build_assoc/3">Ecto.build_assoc</a>
</li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Changeset.html#put_assoc/4">Ecto.Changeset.put_assoc</a>
</li>
</ul>

      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" rel="help" target="_blank">ExDoc</a> (v0.17.1),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" title="@dignifiedquire">Friedel Ziegelmayer</a>.
            </span>
        </p>
        <button class="night-mode-toggle"><span class="sr-only">Switch theme</span></button>
      </footer>
    </div>
  </div>
</section>
</div>
  <script src="dist/app-4cfb39be16.js"></script>
  <script src="assets/makedown.js"></script>
  </body>
</html>

